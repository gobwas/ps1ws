Pub/Sub && 1M WebSockets
14 Apr 2017
Tags: websocket, mailru, optimizations

–°–µ—Ä–≥–µ–π –ö–∞–º–∞—Ä–¥–∏–Ω
MailRu Group
gobwas@gmail.com
https://github.com/gobwas
@gobwas

* –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

–°–ª–∞–π–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã –∑–¥–µ—Å—å: [[talks.godoc.org/github.com/gobwas/nmr/notifier.slide]]

* –ü–ª–∞–Ω

- –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è;
- –¢–µ–æ—Ä–∏—è;
- –ü—Ä–∞–∫—Ç–∏–∫–∞;

* 

.image media/image/01_simplicity.jpg 500 _
.caption "Thaaat's right, Dude. The beauty of this is its simplicity. If the plan gets too complex something always goes wrong."
.caption _Walter._Big_Lebowski._


* –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è

* –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è

–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∑–Ω–∞–µ—Ç –æ –Ω–æ–≤–æ–º –ø–∏—Å—å–º–µ –≤ Web?

- –ü–æ–ª–ª–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã;
- –û–∫–æ–ª–æ 100krps –∑–∞–ø—Ä–æ—Å–æ–≤;
- –ë–æ–ª–µ–µ 60% - HTTP 304;

.code media/diagram/00_history.txt

* –¶–µ–ª—å

–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:

- –ü–µ—Ä–µ—Å—Ç–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–ª–∏–Ω–≥;
- –ü–æ–ª—É—á–∞—Ç—å —Å–∏–≥–Ω–∞–ª—ã/–¥–∞–Ω–Ω—ã–µ –æ –Ω–æ–≤–æ–º –ø–∏—Å—å–º–µ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ;

.code media/diagram/02_target.txt

* –¢–µ–æ—Ä–∏—è

* Publisher/Subscriber

–®–∞–±–ª–æ–Ω –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–æ–±—ã—Ç–∏—è.

*–ò–∑–¥–∞—Ç–µ–ª—å* (_publisher_) –ø—É–±–ª–∏–∫—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –≤ –∫–∞–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π (_event_channel_).

*–ü–æ–¥–ø–∏—Å—á–∏–∫* (_subscriber_) –∏–∑—ä—è–≤–ª—è–µ—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–µ —Å–æ–±—ã—Ç–∏–π.

–í –∫–∞—á–µ—Å—Ç–≤–µ –∫–∞–Ω–∞–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–∂–µ—Ç –≤—ã—Å—Ç—É–ø–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (_message_broker_).

.code media/diagram/01_pubsub.txt

* Publisher/Subscriber

–ü–ª—é—Å—ã:

- C–ª–∞–±–∞—è —Å–æ–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (_loose_coupling_);
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å;

–ú–∏–Ω—É—Å—ã:

- –°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö;
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π –¥–æ—Å—Ç–∞–≤–∫–∏ –±–µ–∑ —É—Å–ª–æ–∂–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞;

* Publisher/Subscriber

–°—É—â–µ—Å—Ç–≤—É—é—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–æ—É—Ç–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:

- –ú—É–ª—å—Ç–∏–≤–µ—â–∞–Ω–∏–µ (_multicasting_);
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (_filtering_);
- Gossiping (_–∞–Ω–≥–ª._—Å–ø–ª–µ—Ç–Ω–∏—á–µ—Å—Ç–≤–æ_);

* WebSocket

–ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º.
–ë–∏–Ω–∞—Ä–Ω—ã–π –∏ –ø–æ–ª–Ω–æ–¥—É–ø–ª–µ–∫—Å–Ω—ã–π.

–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω –∫–∞–∫ [[https://tools.ietf.org/html/rfc6455][RFC6455]] –≤ 2011–≥.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTTP Upgrade –∑–∞–ø—Ä–æ—Å –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤—Å–µ–º–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏.

* 1 –º–∏–ª–ª–∏–æ–Ω —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

.image media/image/cat.jpeg 
.caption –≠—Ç–æ –º–Ω–æ–≥–æ.

* –ü—Ä–∞–∫—Ç–∏–∫–∞

* Publisher/Subscriber

–ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –ø–æ–≤–µ—Ä—Ö IProto.

–ó–∞–≥–æ–ª–æ–≤–æ–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã publister/event –∏ —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π int->[]byte.

–¢–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –ª—é–±—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ —Ä–æ—É—Ç–∏–Ω–≥–µ.

–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–æ–º–æ—â—å—é [[https://github.com/msgpack/msgpack/blob/master/spec.md][msgpack]].

.code media/diagram//03_target.txt

* Publisher/Subscriber

–í —Å–≤—è–∑–∏ —Å –±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ —Å–µ—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–æ—É—Ç–∏–Ω–≥–∞ multicasting –∏ gossiping –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏—Å—å.

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ –≤ –ø–∞–º—è—Ç–∏ —Å –ø–æ–º–æ—â—å—é —Ö—ç—à-—Ç–∞–±–ª–∏—Ü –∏–ª–∏ –¥–µ—Ä–µ–≤—å–µ–≤.

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤–∑—è—Ç—å –ª—é–±—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

.image 02_tree.jpg
.image 03_tree.jpg
.image 04_tree.jpg

* WebSocket

–í–Ω—É—Ç—Ä–∏ —Ñ—Ä–µ–π–º–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç—ã [[https://jsonrpc.org][JSONRPC]].

–í—Å–µ –±—Ä–∞—É–∑–µ—Ä—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç [[https://tools.ietf.org/html/rfc6455][RFC6455]].

–ù–æ –µ—Å—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

- Chrome –Ω–µ –¥–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ `Close` —Ñ—Ä–µ–π–º–∞ –∏ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ;
- Firefox –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–æ—Å—ã–ª–∞–µ—Ç `Ping` —Ñ—Ä–µ–π–º—ã, –æ–∂–∏–¥–∞—è –≤ –æ—Ç–≤–µ—Ç `Pong`;
- IE –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–æ—Å—ã–ª–∞–µ—Ç.. `Pong` —Ñ—Ä–µ–π–º—ã, —á—Ç–æ –Ω–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–ú–Ω–æ–≥–∏–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [[https://tools.ietf.org/html/rfc7692][Compression Extensions]].

* WebSocket

–†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ [[https://tools.ietf.org/html/rfc6455][RFC6455]] –≤ Go:

- [[golang.org/x/net/websocket][x/net/websocket]];
- [[github.com/gorilla/websocket][gorilla/websocket]];
- [[github.com/gobwas/ws][üòé]]

.html media/html/01_plugin.html

* 1 –ú–∏–ª–ª–∏–æ–Ω –°–æ–µ–¥–∏–Ω–µ–Ω–∏–π

- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äì –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—É–Ω–¥ –¥–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å–æ–≤;
- –ß—Ç–æ–±—ã –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –ø–æ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ping –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è; 
- –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫ ‚Äì –º–æ–∂–Ω–æ —É—Å—Ç—Ä–æ–∏—Ç—å self DDOS;

* 1 –ú–∏–ª–ª–∏–æ–Ω –°–æ–µ–¥–∏–Ω–µ–Ω–∏–π

–†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –∏–¥–∏–æ–º–∞—Ö Go –±—É–¥—É—Ç –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏:

.code media/code/00_memory.go /START/,/END/

* –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç runtime?

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –º—ã –≥–æ–≤–æ—Ä–∏–º `conn.Read()`?

	func read(c *conn, p []byte) (int, error) {
		n, err := syscall.Read(c.fd)
		if err == syscall.EAGAIN {
			runtime_pollWait(c.pollDescriptor, 'r')
		}
	}	

- –≤–Ω—É—Ç—Ä–∏ Go —Å–æ–∫–µ—Ç—ã –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ;
- –Ω–∞ Linux `runtime_poll*` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å –ø–æ–º–æ—â—å—é `epoll`;
- —á—Ç–æ –º–µ—à–∞–µ—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å epoll –¥–ª—è —Å–≤–æ–∏—Ö –Ω—É–∂–¥? 

* epoll

* epoll

epoll - I/O event notification facility (c) [[http://man7.org/linux/man-pages/man7/epoll.7.html][_man_epoll_]].

–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

	func (ch *Channel) Receive() error {
		buf := bufio.NewReader(ch.conn) // Allocation only when need!
		for {
			readPacket(buf)
			// ...
		}
	}

	ep := epoll.New()

	// Add add always with EPOLLONESHOT.
	ep.Add(ch.conn, EPOLLIN, func() {
		if err := ch.Receive(); err == nil {
			epoll.Resume(ch.conn)		
		}
	})

* –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏

–ß—Ç–æ –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Ä–µ—à–∞—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ?

–¢–æ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å epoll –Ω–∏—á–µ–º –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ä–µ—Å—É—Ä—Å–æ–µ–º–∫–æ–π idiomatic-way —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

–†–µ—à–µ–Ω–∏–µ ‚Äì –ø—É–ª –≥–æ—Ä—É—Ç–∏–Ω.

* –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏

.code media/code/01_pool.go /START/,/END/

* –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏

–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `bufio.Reader` —Å –ø–æ–º–æ—â—å—é `sync.Pool` –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–æ–π –ø–∞–º—è—Ç–∏.

–ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –ø—É–ª –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å "—Ä–µ–∑–∏–Ω–æ–≤—ã–º".

	p := pool.New(128) // 128 goroutines pool.
	
	epoll.Add(ch.conn, EPOLLIN, func() {
		pool.Schedule(ch.Receive)
	})

* Write 

–° `Write()` –¥–µ–ª–æ –æ–±—Å—Ç–æ–∏—Ç –ø—Ä–æ—â–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã –≤—Å–µ–≥–¥–∞ –∑–Ω–∞–µ–º, –∫–æ–≥–¥–∞ —Ö–æ—Ç–∏–º —á—Ç–æ-—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

–°–ª–æ–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç ‚Äì —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤:

.code media/code/02_write.go /START/,/END/

* github.com/gobwas/ws

* –ü—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –∑–∞–ø–∏–ª–∏—Ç—å —Å–≤–æ—é –ª–∏–±—É

–ö–∞–∫ —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª–æ—Å—å –≤—ã—à–µ, –≤ Go —Å—É—â–µ—Å—Ç–≤—É—é—Ç –¥–≤–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket'–æ–≤.

–ò –æ–±–µ –æ–Ω–∏ [[https://github.com/gorilla/websocket/issues/186][–Ω–µ –ø–æ–∑–≤–æ–ª—è—é—Ç]] –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å `[]byte` –∏ –ø—Ä–æ—á–∏–º–∏ –±—É—Ñ–µ—Ä–∞–º–∏.

–ü–æ—ç—Ç–æ–º—É –ø—Ä–∏—à–ª–æ—Å—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å RFC6455 —Å –±–æ–ª–µ–µ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º API:

	import "github.com/gobwas/ws"

	http.HandleFunc("/", func(res http.ResponseWriter, req *http.Request) {
		conn, _ := ws.Upgrade(req, res)
		
		ws.ReadFrame(conn) 
		ws.WriteFrame(conn, ws.NewTextFrame(...))
	})
	
* Zero-copy Upgrade

–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –∫—É—á–∞ –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ `net/http`, –∫–æ–≥–¥–∞ –Ω–∞–º –Ω—É–∂–Ω–æ –≤—Å–µ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑?

	ln, _ := net.Listen("tcp", ":8888")

	for {
		conn, _ := ln.Accept()
		ws.UpgradeConn(conn)
		// ...
	}

// Benchmarks here


* Zero copy upgrade

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å `pool` –º–æ–∂–Ω–æ –∏–∑–±–µ–≥–∞—Ç—å –ø–ª–æ—Ö–∏—Ö overload —Å–∏—Ç—É–∞—Ü–∏–π:

	ln, _ := net.Listen("tcp", ":8888")

	for {
		conn, _ := ln.Accept()

		err := pool.ScheduleTimeout(func() {
			ws.UpgradeConn(conn)
			// ...
		})
		if err != nil {
			writeNextUpstreamError(conn)
			
			// Handle temporary error like net/http does.
			time.Sleep(...)
		}
	}

* Nginx

- –†–∞–∑–¥–µ–ª–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ;
- –ü–æ–º–æ–≥–∞–µ—Ç —Å DDOS;
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `proxy_next_upstream`

* Graceful restart

- supervisord
- start N instances, wait, stop N instances;
- shutdown message in all parties;
